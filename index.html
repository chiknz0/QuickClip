<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickClip | Pro Meme Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Bebas+Neue&family=Libre+Baskerville:ital@1&family=Playfair+Display:wght@900&family=Space+Mono&display=swap');
        
        :root { scroll-behavior: smooth; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; 
            color: #f8fafc; 
            margin: 0;
            overflow-x: hidden;
        }

        .glass-dark { 
            background: rgba(15, 23, 42, 0.8); 
            backdrop-filter: blur(12px); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
        }

        /* High-End Animations */
        .reveal {
            opacity: 0;
            transform: translateY(40px);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reveal.active {
            opacity: 1;
            transform: translateY(0);
        }

        #canvas-wrapper { 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            background: #020617;
            min-height: 80vh;
        }

        canvas { 
            max-width: 900px; 
            max-height: 600px;
            width: 100%;
            height: auto;
            background: #000;
            box-shadow: 0 40px 100px -20px rgba(0, 0, 0, 0.5);
            border-radius: 24px;
            cursor: crosshair;
            touch-action: none; 
            border: 4px solid #1e293b;
        }

        .btn-action {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            border-radius: 14px;
            padding: 12px 24px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .card-info {
            background: #1e293b;
            padding: 40px;
            border-radius: 32px;
            border: 1px solid #334155;
        }

        input[type="range"] {
            appearance: none;
            background: #334155;
            height: 6px;
            border-radius: 10px;
        }

        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #0f172a;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="custom-scrollbar">

    <!-- Nav -->
    <nav class="fixed top-0 w-full z-[100] glass-dark px-8 py-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg shadow-blue-900/20">Q</div>
            <h1 class="text-xl font-black tracking-tight text-white">QuickClip</h1>
        </div>
        
        <div class="hidden lg:flex gap-8 text-[11px] font-bold uppercase tracking-[0.1em] text-slate-400">
            <a href="#editor-section" class="hover:text-blue-400 transition-colors">Editor</a>
            <a href="#how-to-use" class="hover:text-blue-400 transition-colors">Guide</a>
            <a href="#faq" class="hover:text-blue-400 transition-colors">FAQ</a>
            <a href="#tos" class="hover:text-blue-400 transition-colors">Legal</a>
        </div>
        
        <button id="export-btn" disabled class="btn-action bg-blue-600 text-white disabled:opacity-30 disabled:cursor-not-allowed">
            <span>Export</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        </button>
    </nav>

    <!-- Workspace -->
    <div id="editor-section" class="pt-20">
        <div id="canvas-wrapper" class="reveal active">
            <div class="relative group">
                <canvas id="main-canvas"></canvas>
                
                <div id="upload-overlay" class="absolute inset-0 flex flex-col items-center justify-center gap-4">
                    <button onclick="document.getElementById('file-input').click()" class="bg-slate-800/80 backdrop-blur px-10 py-8 rounded-[40px] border border-slate-700 flex flex-col items-center gap-3 hover:scale-105 transition-all cursor-pointer shadow-2xl">
                        <div class="w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        </div>
                        <span class="font-black text-white uppercase tracking-widest text-sm">Upload Video or Image</span>
                    </button>
                </div>
            </div>

            <!-- Editor Controls -->
            <div class="mt-12 w-full max-w-4xl space-y-8 px-4">
                <div class="flex flex-wrap items-center justify-center gap-6">
                    <button id="add-text-btn" class="btn-action bg-white text-slate-900 px-10 py-5 text-lg hover:bg-blue-50">
                        + New Caption
                    </button>
                    
                    <div id="text-editor" class="hidden flex flex-wrap items-center gap-4 bg-slate-800 p-3 rounded-2xl border border-slate-700 shadow-xl animate-in fade-in zoom-in duration-300">
                        <input type="text" id="edit-text-val" class="bg-slate-900 text-white px-5 py-3 text-sm w-64 rounded-xl outline-none border border-slate-700 focus:border-blue-500 transition-colors" placeholder="Write something cool...">
                        
                        <div class="flex items-center gap-2 bg-slate-900 p-1 rounded-xl border border-slate-700">
                            <select id="edit-text-font" class="bg-transparent text-white px-3 py-2 text-xs font-bold outline-none cursor-pointer">
                                <option value="Inter">Classic</option>
                                <option value="Bebas Neue">Meme Style</option>
                                <option value="Playfair Display">Elegant</option>
                                <option value="Space Mono">Modern</option>
                            </select>
                        </div>

                        <input type="color" id="edit-text-color" class="w-10 h-10 rounded-xl cursor-pointer bg-transparent border-none">
                        
                        <div class="h-8 w-px bg-slate-700 mx-2"></div>
                        
                        <button id="delete-text-btn" class="p-3 text-slate-400 hover:text-red-500 transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                </div>

                <div class="bg-slate-800 p-8 rounded-[32px] border border-slate-700 shadow-lg flex flex-col gap-6">
                    <div class="flex justify-between items-center text-xs font-black text-slate-400 uppercase tracking-widest">
                        <span>Top Margin (Header)</span>
                        <span id="header-val" class="text-blue-400 bg-blue-500/10 px-3 py-1 rounded-full">100px</span>
                    </div>
                    <input type="range" id="header-height-input" min="0" max="500" value="100" class="w-full">
                </div>
            </div>
        </div>

        <!-- Video Tools -->
        <div id="timeline-ui" class="hidden bg-slate-900 border-t border-slate-800 p-10 reveal">
            <div class="max-w-6xl mx-auto grid lg:grid-cols-[auto_1fr_auto] items-center gap-12">
                <button id="play-pause" class="w-16 h-16 bg-blue-600 text-white rounded-[24px] flex items-center justify-center shadow-xl shadow-blue-900/40 hover:scale-105 transition-all">
                    <svg id="play-icon" class="w-8 h-8 fill-white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                
                <div class="space-y-6">
                    <div class="relative h-2 bg-slate-800 rounded-full">
                        <input type="range" id="seek-bar" value="0" class="absolute inset-0 w-full z-10 cursor-pointer">
                    </div>
                    <div class="flex justify-between text-xs font-black text-slate-500 uppercase tracking-widest">
                        <span id="time-current" class="font-mono text-slate-300">00:00</span>
                        <div class="flex gap-8">
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <div class="relative w-10 h-6 bg-slate-700 rounded-full transition-colors group-hover:bg-slate-600">
                                    <input type="checkbox" id="fade-opt" class="sr-only peer">
                                    <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-all peer-checked:left-5 peer-checked:bg-blue-400"></div>
                                </div>
                                <span class="group-hover:text-white transition-colors">Fade FX</span>
                            </label>
                            <span id="time-total" class="font-mono">00:00</span>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 flex items-center gap-6 shadow-inner">
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-tighter">Start Time</p>
                        <input type="number" id="trim-start" step="0.1" value="0" class="w-20 bg-slate-900 border border-slate-700 rounded-xl py-2 text-center font-bold text-white outline-none focus:border-blue-500">
                    </div>
                    <div class="w-6 h-px bg-slate-700"></div>
                    <div class="text-center">
                        <p class="text-[10px] font-black text-slate-500 mb-2 uppercase tracking-tighter">End Time</p>
                        <input type="number" id="trim-end" step="0.1" value="5" class="w-20 bg-slate-900 border border-slate-700 rounded-xl py-2 text-center font-bold text-white outline-none focus:border-blue-500">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Sections -->
    <section id="how-to-use" class="max-w-6xl mx-auto px-8 py-32 reveal">
        <h2 class="text-5xl font-black mb-16 tracking-tighter text-white">The Workflow</h2>
        <div class="grid md:grid-cols-3 gap-10">
            <div class="card-info hover:border-blue-500/30 transition-colors">
                <div class="w-14 h-14 bg-blue-500/10 text-blue-400 rounded-2xl flex items-center justify-center font-black text-xl mb-8 border border-blue-500/20">1</div>
                <h3 class="text-2xl font-bold mb-4 text-white">Import</h3>
                <p class="text-slate-400 leading-relaxed">Select any video or image. We process everything locally in your browser for maximum speed and privacy.</p>
            </div>
            <div class="card-info hover:border-blue-500/30 transition-colors">
                <div class="w-14 h-14 bg-blue-500/10 text-blue-400 rounded-2xl flex items-center justify-center font-black text-xl mb-8 border border-blue-500/20">2</div>
                <h3 class="text-2xl font-bold mb-4 text-white">Design</h3>
                <p class="text-slate-400 leading-relaxed">Add captions with professional fonts. Drag them around, resize, and use the top padding for that classic "meme" look.</p>
            </div>
            <div class="card-info hover:border-blue-500/30 transition-colors">
                <div class="w-14 h-14 bg-blue-500/10 text-blue-400 rounded-2xl flex items-center justify-center font-black text-xl mb-8 border border-blue-500/20">3</div>
                <h3 class="text-2xl font-bold mb-4 text-white">Render</h3>
                <p class="text-slate-400 leading-relaxed">Clip the duration and export to high-quality GIF. Perfect for Discord, Twitter, or Group Chats.</p>
            </div>
        </div>
    </section>

    <section id="faq" class="max-w-4xl mx-auto px-8 py-32 reveal">
        <h2 class="text-5xl font-black mb-16 tracking-tighter text-white">FAQ</h2>
        <div class="space-y-6">
            <details class="card-info cursor-pointer group p-8 bg-slate-800/50">
                <summary class="list-none text-xl font-bold flex justify-between items-center text-white">
                    Why isn't my video loading?
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs group-open:rotate-180 transition-transform">▼</div>
                </summary>
                <p class="mt-6 text-slate-400 leading-relaxed">Ensure your file is in .mp4 format. Some high-bitrate 4K files may be heavy for your browser memory—try to keep clips under 30 seconds for best performance.</p>
            </details>
            <details class="card-info cursor-pointer group p-8 bg-slate-800/50">
                <summary class="list-none text-xl font-bold flex justify-between items-center text-white">
                    Is my data private?
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs group-open:rotate-180 transition-transform">▼</div>
                </summary>
                <p class="mt-6 text-slate-400 leading-relaxed">100%. QuickClip never uploads your files to a server. All the rendering happens right on your computer.</p>
            </details>
            <details class="card-info cursor-pointer group p-8 bg-slate-800/50">
                <summary class="list-none text-xl font-bold flex justify-between items-center text-white">
                    Can I make multi-line captions?
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs group-open:rotate-180 transition-transform">▼</div>
                </summary>
                <p class="mt-6 text-slate-400 leading-relaxed">Yes! The tool automatically wraps text if it gets too long, and you can add as many individual caption layers as you need.</p>
            </details>
        </div>
    </section>

    <section id="tos" class="max-w-4xl mx-auto px-8 py-32 reveal">
        <h2 class="text-3xl font-black mb-12 tracking-tight text-white">Terms of Service</h2>
        <div class="card-info text-slate-400 text-sm leading-relaxed border-slate-800">
            <p class="mb-4">QuickClip is provided as a creative tool for self-expression. By using this service, you agree not to create content that is harmful, illegal, or violates the rights of others. We promote a healthy, respectful creator community.</p>
            <p>We do not collect or monitor your creations. Use responsibly.</p>
        </div>
    </section>

    <footer class="py-20 text-center border-t border-slate-800/50 text-slate-500 font-bold text-xs uppercase tracking-widest">
        Made by chknz 2026 &bull; QuickClip Pro Meme Editor
    </footer>

    <input type="file" id="file-input" class="hidden" accept="video/*,image/*">

    <!-- Modal -->
    <div id="result-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-950/90 backdrop-blur-2xl">
        <div class="bg-slate-900 max-w-2xl w-full p-12 rounded-[48px] text-center shadow-[0_0_100px_rgba(59,130,246,0.1)] border border-slate-800">
            <h2 class="text-3xl font-black text-white mb-10 tracking-tight">Export Successful</h2>
            <img id="final-result" src="" class="max-h-[50vh] mx-auto object-contain rounded-3xl shadow-2xl mb-10 border border-slate-700">
            <div class="flex gap-4">
                <button id="download-trigger" class="flex-grow btn-action bg-blue-600 text-white py-5 text-lg">Download GIF</button>
                <button onclick="closeModal()" class="px-10 btn-action bg-slate-800 text-white hover:bg-slate-700">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Intersection Observer for Reveal Anims
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) entry.target.classList.add('active');
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

        window.onload = () => {
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            const video = document.createElement('video');
            video.crossOrigin = "anonymous";
            video.loop = true;

            let headerHeight = 100;
            let mediaLayer = { x: 0, y: 100, w: 1280, h: 620, type: 'media', aspect: 1, source: null };
            let textLayers = [];
            let selectedLayer = null;
            let dragTarget = null;
            let resizeHandle = null;
            let isDragging = false;
            let startX, startY;

            canvas.width = 1280;
            canvas.height = 720;

            document.getElementById('file-input').onchange = e => handleFile(e.target.files[0]);
            document.getElementById('header-height-input').oninput = e => {
                headerHeight = parseInt(e.target.value);
                document.getElementById('header-val').innerText = headerHeight + 'px';
                mediaLayer.y = headerHeight;
                mediaLayer.h = canvas.height - headerHeight;
            };

            function handleFile(file) {
                if (!file) return;
                const url = URL.createObjectURL(file);
                if (file.type.includes('video')) {
                    video.src = url;
                    video.onloadedmetadata = () => {
                        mediaLayer.source = video;
                        mediaLayer.aspect = video.videoWidth / video.videoHeight;
                        mediaLayer.h = canvas.height - headerHeight;
                        mediaLayer.w = mediaLayer.h * mediaLayer.aspect;
                        mediaLayer.x = (canvas.width - mediaLayer.w) / 2;
                        document.getElementById('trim-end').value = Math.min(video.duration, 5).toFixed(1);
                        document.getElementById('time-total').innerText = formatTime(video.duration);
                        document.getElementById('timeline-ui').classList.remove('hidden');
                        document.getElementById('upload-overlay').classList.add('hidden');
                        document.getElementById('export-btn').disabled = false;
                    };
                } else {
                    const img = new Image();
                    img.onload = () => {
                        mediaLayer.source = img;
                        mediaLayer.aspect = img.width / img.height;
                        mediaLayer.h = canvas.height - headerHeight;
                        mediaLayer.w = mediaLayer.h * mediaLayer.aspect;
                        mediaLayer.x = (canvas.width - mediaLayer.w) / 2;
                        document.getElementById('upload-overlay').classList.add('hidden');
                        document.getElementById('export-btn').disabled = false;
                        document.getElementById('timeline-ui').classList.add('hidden');
                    };
                    img.src = url;
                }
            }

            function formatTime(s) {
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            }

            canvas.onmousedown = e => {
                const pos = getMousePos(e);
                startX = pos.x; startY = pos.y;
                dragTarget = null; resizeHandle = null;

                const layers = [...textLayers, mediaLayer];
                for (let layer of layers) {
                    const h = getHandles(layer);
                    for (let key in h) {
                        if (Math.hypot(pos.x - h[key].x, pos.y - h[key].y) < 30) {
                            resizeHandle = key;
                            dragTarget = layer;
                            selectedLayer = layer;
                            updateEditorUI();
                            return;
                        }
                    }
                }

                for (let i = layers.length - 1; i >= 0; i--) {
                    const l = layers[i];
                    if (pos.x >= l.x && pos.x <= l.x + l.w && pos.y >= l.y && pos.y <= l.y + l.h) {
                        dragTarget = l;
                        selectedLayer = l;
                        isDragging = true;
                        updateEditorUI();
                        return;
                    }
                }
                selectedLayer = null; updateEditorUI();
            };

            window.onmousemove = e => {
                if (!dragTarget) return;
                const pos = getMousePos(e);
                if (resizeHandle) {
                    if (resizeHandle === 'br') {
                        dragTarget.w = Math.max(100, pos.x - dragTarget.x);
                        if (dragTarget.type === 'media') dragTarget.h = dragTarget.w / dragTarget.aspect;
                        else {
                            // Scale text size roughly with box height for intuitive resizing
                            dragTarget.h = Math.max(50, pos.y - dragTarget.y);
                            if (dragTarget.type === 'text') dragTarget.size = dragTarget.h * 0.8;
                        }
                    } else if (resizeHandle === 'tl') {
                        const dw = dragTarget.x - pos.x;
                        const dh = dragTarget.y - pos.y;
                        dragTarget.x = pos.x;
                        dragTarget.y = pos.y;
                        dragTarget.w += dw;
                        dragTarget.h += dh;
                    }
                } else if (isDragging) {
                    dragTarget.x += (pos.x - startX);
                    dragTarget.y += (pos.y - startY);
                    startX = pos.x; startY = pos.y;
                }
            };

            window.onmouseup = () => { dragTarget = null; resizeHandle = null; isDragging = false; };

            function getMousePos(e) {
                const rect = canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left) * (canvas.width / rect.width),
                    y: (e.clientY - rect.top) * (canvas.height / rect.height)
                };
            }

            function getHandles(l) {
                return {
                    tl: { x: l.x, y: l.y },
                    br: { x: l.x + l.w, y: l.y + l.h }
                };
            }

            // Text Wrapping Engine
            function wrapText(ctx, text, maxWidth) {
                let words = text.split(' ');
                let lines = [];
                let currentLine = words[0];

                for (let i = 1; i < words.length; i++) {
                    let word = words[i];
                    let width = ctx.measureText(currentLine + " " + word).width;
                    if (width < maxWidth) {
                        currentLine += " " + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                }
                lines.push(currentLine);
                return lines;
            }

            function renderFrame(ctxTarget, clear = true, currentT = 0) {
                if (clear) {
                    ctxTarget.fillStyle = "#000";
                    ctxTarget.fillRect(0, 0, canvas.width, canvas.height);
                }
                ctxTarget.fillStyle = "#fff";
                ctxTarget.fillRect(0, 0, canvas.width, headerHeight);

                if (mediaLayer.source) {
                    ctxTarget.drawImage(mediaLayer.source, mediaLayer.x, mediaLayer.y, mediaLayer.w, mediaLayer.h);
                }

                const useFade = document.getElementById('fade-opt').checked;
                const trimStart = parseFloat(document.getElementById('trim-start').value);
                const trimEnd = parseFloat(document.getElementById('trim-end').value);

                textLayers.forEach(l => {
                    let alpha = 1;
                    if (useFade && video.src) {
                        const relativePos = currentT - trimStart;
                        const totalDur = trimEnd - trimStart;
                        if (relativePos < 0.5) alpha = relativePos / 0.5;
                        if (relativePos > totalDur - 0.5) alpha = (totalDur - relativePos) / 0.5;
                    }
                    
                    ctxTarget.save();
                    ctxTarget.globalAlpha = Math.max(0, Math.min(1, alpha));
                    ctxTarget.fillStyle = l.color;
                    ctxTarget.font = `900 ${l.size}px ${l.font}`;
                    ctxTarget.textBaseline = 'top';
                    ctxTarget.textAlign = 'center';
                    
                    // Use wrapText to prevent overflow
                    const lines = wrapText(ctxTarget, l.text, l.w - 20);
                    const lineHeight = l.size * 1.1;
                    
                    lines.forEach((line, i) => {
                        ctxTarget.fillText(line, l.x + l.w/2, l.y + (i * lineHeight));
                    });
                    
                    // Update bounds for hit detection
                    l.h = lines.length * lineHeight;
                    ctxTarget.restore();
                });
            }

            function draw() {
                renderFrame(ctx, true, video.currentTime);
                if (selectedLayer) {
                    ctx.strokeStyle = "#3b82f6"; ctx.lineWidth = 4;
                    ctx.setLineDash([8, 4]);
                    ctx.strokeRect(selectedLayer.x, selectedLayer.y, selectedLayer.w, selectedLayer.h);
                    ctx.setLineDash([]);
                    const h = getHandles(selectedLayer);
                    ctx.fillStyle = "#3b82f6"; ctx.strokeStyle="#fff"; ctx.lineWidth=3;
                    for (let key in h) {
                        ctx.beginPath(); ctx.arc(h[key].x, h[key].y, 12, 0, Math.PI*2);
                        ctx.fill(); ctx.stroke();
                    }
                }
                if (video.src && !video.paused) {
                    const p = (video.currentTime / video.duration) * 100;
                    document.getElementById('seek-bar').value = p;
                    document.getElementById('time-current').innerText = formatTime(video.currentTime);
                }
                requestAnimationFrame(draw);
            }
            draw();

            document.getElementById('add-text-btn').onclick = () => {
                const newT = { type: 'text', text: 'WRITE CAPTION', x: canvas.width/2 - 300, y: 20, w: 600, h: 80, color: '#000000', size: 60, font: 'Inter' };
                textLayers.push(newT); selectedLayer = newT; updateEditorUI();
            };

            function updateEditorUI() {
                const editor = document.getElementById('text-editor');
                if (selectedLayer && selectedLayer.type === 'text') {
                    editor.classList.remove('hidden');
                    document.getElementById('edit-text-val').value = selectedLayer.text;
                    document.getElementById('edit-text-color').value = selectedLayer.color;
                    document.getElementById('edit-text-font').value = selectedLayer.font;
                } else editor.classList.add('hidden');
            }

            document.getElementById('edit-text-val').oninput = e => { if (selectedLayer) selectedLayer.text = e.target.value; };
            document.getElementById('edit-text-color').oninput = e => { if (selectedLayer) selectedLayer.color = e.target.value; };
            document.getElementById('edit-text-font').onchange = e => { if (selectedLayer) selectedLayer.font = e.target.value; };
            document.getElementById('delete-text-btn').onclick = () => { textLayers = textLayers.filter(l => l !== selectedLayer); selectedLayer = null; updateEditorUI(); };
            
            document.getElementById('play-pause').onclick = () => { 
                video.paused ? video.play() : video.pause();
                document.getElementById('play-icon').innerHTML = video.paused ? '<path d="M8 5v14l11-7z"/>' : '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
            };
            
            document.getElementById('seek-bar').oninput = e => { video.currentTime = (e.target.value / 100) * video.duration; };

            async function getWorkerBlob() {
                const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                const script = await response.text();
                return URL.createObjectURL(new Blob([script], { type: 'application/javascript' }));
            }

            document.getElementById('export-btn').onclick = async () => {
                const btn = document.getElementById('export-btn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerText = "Processing Frames...";
                
                const workerUrl = await getWorkerBlob();
                const gif = new GIF({ workers: 4, quality: 15, width: canvas.width/2, height: canvas.height/2, workerScript: workerUrl });

                if (video.src && mediaLayer.source === video) {
                    const fps = 8;
                    const start = parseFloat(document.getElementById('trim-start').value);
                    const end = parseFloat(document.getElementById('trim-end').value);
                    const totalFrames = Math.floor((end - start) * fps);
                    const offCanvas = document.createElement('canvas');
                    offCanvas.width = canvas.width/2; offCanvas.height = canvas.height/2;
                    const octx = offCanvas.getContext('2d'); octx.scale(0.5, 0.5);

                    video.pause();
                    for (let i = 0; i < totalFrames; i++) {
                        const currentT = start + (i / fps);
                        video.currentTime = currentT;
                        await new Promise(r => video.onseeked = r);
                        renderFrame(octx, true, currentT);
                        gif.addFrame(offCanvas, {delay: 1000/fps, copy: true});
                        btn.innerText = `Rendering ${Math.round((i/totalFrames)*100)}%`;
                    }
                } else {
                    gif.addFrame(canvas, {delay: 500});
                }

                btn.innerText = "Assembling GIF...";
                gif.on('finished', blob => {
                    document.getElementById('final-result').src = URL.createObjectURL(blob);
                    document.getElementById('result-modal').classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    document.getElementById('download-trigger').onclick = () => {
                        const a = document.createElement('a'); a.href = document.getElementById('final-result').src;
                        a.download = 'quickclip-meme.gif'; a.click();
                    };
                });
                gif.render();
            };
        };
        window.closeModal = () => document.getElementById('result-modal').classList.add('hidden');
    </script>
</body>
</html>
